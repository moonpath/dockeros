#!/bin/bash
set -x

sudo chown `whoami`:`whoami` $HOME
cp --update=none /etc/skel/.bashrc /etc/skel/.profile /etc/skel/.bash_logout $HOME/

: ${NOVNC_PORT:=7900}
: ${NOVNC_USER:=user}
: ${NOVNC_PASSWORD:=password}
: ${NOVNC_AUTH:=false}
echo -e "$NOVNC_PASSWORD\n$NOVNC_PASSWORD\n" | vncpasswd -u $NOVNC_USER -o -w -r
for session in $(vncserver -list | grep '^:' | awk '{print $1}'); do vncserver -kill "$session"; done
rm -rf /tmp/.X*-lock /tmp/.X11-unix
vncserver -select-de XFCE -SecurityTypes None -UseIPv6 0 -sslOnly 0 -localhost 0 -websocketPort 6901 :1

sudo sed -i "s/EXEUSER=\"[^\"]*\"/EXEUSER=\"`whoami`\"/" /etc/init.d/kclient

sudo ln -s /etc/nginx/sites-available/webos /etc/nginx/sites-enabled/webos
sudo sed -i "s/\$HTTP_PORT/$NOVNC_PORT/" /etc/nginx/sites-available/webos
sudo sed -i "s/\$HTTPS_PORT/$((NOVNC_PORT+1))/" /etc/nginx/sites-available/webos
sudo sed -i "s/\$HTTP_BASIC_AUTH/$(echo -n "${NOVNC_USER}:${NOVNC_PASSWORD}" | base64)/" /etc/nginx/sites-available/webos
printf "${NOVNC_USER}:$(openssl passwd -apr1 ${NOVNC_PASSWORD})\n" | sudo tee /etc/nginx/.htpasswd >>/dev/null

if [ "$NOVNC_AUTH" = "false" ]; then
    sudo sed -i 's/auth_basic/#auth_basic/g' /etc/nginx/sites-available/webos
    sudo sed -i 's/auth_basic_user_file/#auth_basic_user_file/g' /etc/nginx/sites-available/webos
fi

sudo service dbus start
pulseaudio --start --disallow-exit --exit-idle-time=-1
sudo service kclient start
sudo service nginx start

mkdir -p $HOME/Desktop

cp --update=none /usr/share/applications/code.desktop $HOME/Desktop/code.desktop
chmod 755 $HOME/Desktop/code.desktop

cp --update=none /usr/share/applications/microsoft-edge.desktop $HOME/Desktop/microsoft-edge.desktop
chmod 755 $HOME/Desktop/microsoft-edge.desktop

cp --update=none /usr/local/share/JetBrains/Toolbox/jetbrains-toolbox.desktop $HOME/Desktop/
chmod 755 $HOME/Desktop/jetbrains-toolbox.desktop

if [ -f ~/.startup ]; then
    . ~/.startup
fi

set -ex
exec "$@"
